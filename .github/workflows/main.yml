# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          submodules: true
          
      # In this step, this action saves a list of existing images,
      # the cache is created without them in the post run.
      # It also restores the cache if it exists.
      - uses: satackey/action-docker-layer-caching@v0.0.8
        # Ignore the failure of a step and avoid terminating the job.
        continue-on-error: true  
      
      - name: Build dockerfile
        run: docker build -t cjen1/rc:latest .

      - name: Run basic test
        run: 
          docker run --privileged --tmpfs /data --network host --name rc --entrypoint /bin/bash cjen1/rc:latest -c 
          "service openvswitch-switch start 
          && ovs-vsctl set-manager ptcp:6640 
          && python benchmark.py etcd_go 
            simple --topo_args n=1,nc=1 uniform --dist_args write_ratio=1 none 
            --benchmark_config rate=1000 duration=10 dest=./res logs=./logs `realpath .`
          && service openvswitch-switch stop"
